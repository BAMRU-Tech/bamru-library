NYT Library [![CircleCI](https://circleci.com/gh/newsdev/nyt-library/tree/master.svg?style=svg&circle-***REMOVED***)](https://circleci.com/gh/newsdev/nyt-library/tree/master)
========

A collaborative newsroom documentation site, powered by Google Docs.

## Development Workflow

1. Clone and `cd` into the repo:

   `git clone git@github.com:newsdev/nyt-library.git && cd nyt-library`


2. From the Google API console, create a service account with API access to docs
   and cloud datastore. Store these credentials in `server/.auth.json`.

   - If you are working with oAuth, you will also need to create oAuth credentials.

3. Install dependencies:

   `yarn install --ignore-optional`

4. Create a `.env` file at the project root. An example `.env` might look like

```bash
NODE_ENV=development # node environment
# Google oAuth credentials
GOOGLE_CLIENT_ID=123456-abcdefg.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=abcxyz12345
APPROVED_DOMAINS="nytimes.com,dailypennsylvanian.com" # comma separated list of approved access domains.
SESSION_SECRET=supersecretvalue

# Google drive Configuration
DRIVE_TYPE=team # or shared, if using a folder instead of a team drive
DRIVE_ID=0123456ABCDEF # the ID of your team's drive
```

5. Start the app:

   `npm run build && npm run watch`

The app should now be running at localhost:3000.

### Tests

You can run functional and unit tests, which test HTML parsing and routing logic, with `npm test`. A coverage report can be generated by running `npm run test:cover`.

<!-- NB this needs to change eventually -->
The HTML parsing tests are based on the [Supported Formats doc](https://docs.google.com/document/d/***REMOVED***/edit).  To download a fresh copy of the HTML after making edits, run `node test/data/update.js`.

### Beta API
You must also set a `API_KEY` environment variable to a key created by a whitelisted
organization if you wish to use the Google Docs v4 API. While this API does not
currently support all the necessary features for a full implementation, you can
render a page using the beta API by appending the `?beta` query string, or setting
the `USE_BETA` environment variable to `true`.

## Customization
Styles, text, middleware, caching logic, and middleware can be customized to
match the branding of your organization. This is covered in the [customization readme](https://github.com/newsdev/nyt-library/blob/master/custom/README.md).


## Deploying the app

**Heroku deploy TKTKTKT**

This app is hosted on the [Interactive News infrastructure](***REMOVED***/wiki).  To deploy a code change:

  * Use the [stg deploy page](https://***REMOVED***/***REMOVED***/default/deploy) to cut a release.  Once the build is complete, you'll see a link that says "Make this version active."  Click this to push the version live.  It may take a minute or two for the new version to start.
  * You can see additional information about the deployment on the [app detail page](https://***REMOVED***/***REMOVED***/default), access logs, edit environmental variables, and retrieve commands to open a bash prompt on the staging servers.
  * When you're ready to move the app to prodution, select the release tag you just created on the [prd deploy page](https://***REMOVED***/***REMOVED***/default/deploy), then click "Make this version active."
  * After deployment, visit [https://***REMOVED***/cache-purge-everything](https://***REMOVED***/cache-purge-everything) to flush the app's internal caches.

---

## App structure

### Server

The main entry point to the app is index.js.

This file contains the basic express server which will respond to requests for docs in the [NYT Docs Team Drive](https://drive.google.com/drive/u/0/folders/***REMOVED***). It contains logic about issuing 404s and selecting the template to use based on the path.

### Views

Views (layouts) are located in the `layouts` folder.  They use the `.ejs` extension, which uses a syntax similar to underscore templates.

Base styles for the views are in the `styles` directory containing Sass files.
These files are compiled to CSS and placed in `public/css`.

### Doc parsing

Doc HTML fetch and parsing is handled by `docs.js`.  `fetchDoc` takes the ID of a Google doc and a callback, then passes the HTML of the document into the callback once it has ben downloaded and processed.

### Listing the drive

Traversing the contents of the NYT Docs folder is handled by [`list.js`](https://github.com/newsdev/nyt-docs/blob/master/list.js).  There are two exported functions:

  * `getTree` is an async call that returns a nested hash (tree) of Google Drive Folder IDs mapped to their children. It is used by the server to determine whether a route is valid or not.

  * `getMeta` synchronously returns a hash of Google Doc IDs to metadata objects that were saved in the course of populating the tree. [TK what does htis metadata contain].

The tree and file metadata are repopulated into memory on an interval (currently 60s). Calling getTree multiple times will not return fresher data.

### Auth

Authentication with the Google Drive v3 api is handled by the auth.js file, which exposes a single method `getAuth`. `getAuth` will either return an already instantiated authentication client or produce a fresh one. Calling `getAuth` multiple times will not produce a new authentication client if the credentials have expired; we should build this into the auth.js file later to automatically refresh the credentials on some sort of interval to prevent them from expiring.

### Previous code from tools.nyt.net

Library is based on a tool that was written by @thomasrhiel (***REMOVED***), although it shares no code with this project.
